---
marp: true
---

# Quine 入門してみた

2025/03/13 tyamap

---

# 山下智矢 Yamashita Tomoya

- やまぴー・ぴーやま・ぴーさん
- 文学部出身の本の虫
- 2019 ~ 中小 SIer
- 2021 ~ 株式会社 InnerResource
- 2025 ~ 株式会社メドレー

---

# Quine とは

> 自身のソースコードと完全に同じ
> 文字列を出力するプログラム

![bg right:48% 80%](../assets/20250311_1.png)

---

# 私 と Quine

1. 初参加・単身参加した
   RubyKaigi 2024 で初めて知る
2. `puts "puts 'puts'..."`
3. 前職を退職する時に
   Quine でサービスロゴが書かれた
   パーカーをいただく 😳
4. 自分も書きたいと思い立ち
   LT に申し込む

![bg right:48% 80%](../assets/20250311_2.png)

---

# シンプルなサンプル

OK ChatGPT, シンプルな Quine を出力して

```rb
eval$s=%q(puts "eval$s=%q(#{$s})")
```

---

# 解説

```rb
eval$s=%q(puts "eval$s=%q(#{$s})")
```

### `eval`

- 引数の文字列をそのまま ruby コードとして実行する

### `$s`

- 変数のプレフィクスに `$` をつけることで、グローバル変数になる
- → 関数のあとの括弧やスペースを省略できる

### `%q`

- `%q()`, `%q''`, `%q{}` で囲むと、シングルクォートで囲むのと同じ

---

# アスキーアート Quine を書きたい

プレゼントしてもらったパーカーのような、AA Quine を書きたい

参考: https://mickey24.hatenablog.com/entry/20100915/ruby_udonge_quine

---

# AA Quine のポイント

### `%w` と `join`

- `%w()` でスペース区切りの要素を囲むと文字列配列になる
- 任意の箇所にスペースを書けるようになる

```ruby
eval %w(
pu  ts
  "h   e   ll  o"
).join
# => hello
```

### 容量圧縮

`Quineのソースコードで使える最大文字数 = AA中の文字の数`

---

### AA を構造データ化

```rb
aa = <<~EOM
11111111100000000000000111111111100000001111111111111111111111100000011111111111111111000000000000000001111111111000000000000000000111111111111111111111110011111111110000000000111111111
11111111110000000000001111111111100000001111111111111111111111100000011111111111111111111110000000000001111111111000000000000000000111111111111111111111110011111111110000000001111111111
11111111111000000000001111111111100000001111111111111111111111100000011111111111111111111111100000000001111111111000000000000000000111111111111111111111110001111111111000000001111111110
11111111111100000000011111111111100000001111111111111111111111100000011111111111111111111111111000000001111111111000000000000000000111111111111111111111110000111111111100000011111111100
11111111111100000000111111111111100000001111111110000000000000000000011111111110000111111111111100000001111111111000000000000000000111111111000000000000000000011111111110000111111111000
11111111111110000001111111111111100000001111111110000000000000000000011111111110000000111111111110000001111111111000000000000000000111111111000000000000000000001111111110001111111110000
11111111111111000001111111111111100000001111111110000000000000000000011111111110000000011111111110000001111111111000000000000000000111111111000000000000000000000111111111001111111100000
11111111111111100011111111111111100000001111111111111111111110000000011111111110000000001111111110000001111111111000000000000000000111111111111111111111000000000011111111111111111000000
11111111111111100111111111111111100000001111111111111111111110000000011111111110000000001111111111000001111111111000000000000000000111111111111111111111000000000001111111111111110000000
11111111011111110111111101111111100000001111111111111111111110000000011111111110000000001111111111000001111111111000000000000000000111111111111111111111000000000000111111111111100000000
11111111001111111111111001111111100000001111111111111111111110000000011111111110000000001111111110000001111111111000000000000000000111111111111111111111000000000000011111111111000000000
11111111001111111111111001111111100000001111111110000000000000000000011111111110000000001111111110000001111111111000000000000000000111111111000000000000000000000000001111111110000000000
11111111000111111111110001111111100000001111111110000000000000000000011111111110000000011111111100000001111111111000000000000000000111111111000000000000000000000000001111111110000000000
11111111000111111111110001111111100000001111111110000000000000000000011111111110000001111111111100000001111111111000000000000000000111111111000000000000000000000000001111111110000000000
11111111000011111111100001111111100000001111111111111111111111110000011111111111111111111111111000000001111111111111111111111100000111111111111111111111110000000000001111111110000000000
11111111000011111111100001111111100000001111111111111111111111110000011111111111111111111111110000000001111111111111111111111100000111111111111111111111110000000000001111111110000000000
11111111000001111111000001111111100000001111111111111111111111110000011111111111111111111111000000000001111111111111111111111100000111111111111111111111110000000000001111111110000000000
11111111000000000000000001111111100000001111111111111111111111110000011111111111111111110000000000000001111111111111111111111100000111111111111111111111110000000000001111111110000000000
EOM
```

バイナリを整数に変換したものを AA の構造データとして保持する
バイナリ AA の最後が 0 であれば、reverse すると節約できる

```rb
bits = aa.gsub("\n", "").reverse.to_i(2)
puts bits.to_s.size # => 1000
```

全文字数 `3330`, コード部分（1 で表現した部分）文字数 `1971` の AA が
1000 桁の整数になった

---

### 構造データをさらに圧縮

`Marshal.dump` でシリアライズし、 `Array#pack` で Base64 エンコードすることで
さらに圧縮

```rb
bin = [Marshal.dump(bits)].pack("m").gsub("\n", "")
puts bin.length # => 564
```

これで処理部分にかけるコードが増える

---

ゴニョゴニョ

```rb
eval$s=%w'b="BAhsKwHQ/wGA/wH//3/g/z8AgP8BAPj///M/AP//B4D/A/7//8D//w8A/wMA8P//538A//8fAP
8H/P//gf//fwD+BwDg//+P/wH++38A/w/4//8D////A/wPAMD//x/+B/7z/wD/H/AfAAD+h/8P+B8AgP8AAPgf/
uP/A/8/4D8AAPwP+D/wPwAA/wEA4D/+w/8P/n/AfwAA+B/gf+B/AAD+AwCA//yD/z/+/4D//w/wP4D/wP8AAPz/
fwD+/wP/f/7/Af//H+B/AP+D/wEA+P//APj/A/79/f0D/v8/wP8A/gf/AwDw//8B4P8D/PP/+Qf8/3+A/wH8B/4
HAOD//wOA/wP45//zD/gPAAD/A/gP/A8AwH8AAAD+A/CP/+Mf8B8AAP4H+A/4HwCA/wAAAPwH4B//xz/gPwAA/A
/8H/A/AAD/AQAA+A/AP/yHf8D//z/4//8f4P//D/7//wDwH4B/+A//gP//f/D//x/A//8f/P//AeA/AP/gD/4B/
///4P//D4D//z/4//8DwH8A/gEA/AP+///B//8BAP//f/D//weA/wA=";n=Marshal.load(b.unpack("m")[0
]);e="eval$s=%w"<<39<<($s*3);o="";j=-1;0.upto(18*185-1){|i|;  o<<((n[i]==1)?e[j+=1]:32);
  o<<((i%185==(184))?10:"");};o[-17,6]=""<<39<<".join";puts(o)#'.join
```

これを実行すると……

---

```
eval$s=%w              'b="BAhsKw       HQ/wGA/wH//3/g/z8AgP8BA      Pj///M/AP//B4D/A/                 7//8D//w8A                  /wMA8P//538A//8fAP8H/P/  /gf//fwD+B          wDg//+P/w
H++38A/w/4            //8D////A/w       PAMD//x/+B/7z/wD/H/AfAA      D+h/8P+B8AgP8AAPgf/uP/            A/8/4D8AAP                  wP+D/wPwAA/wEA4D/+w/8P/  n/AfwAA+B/         gf+B/AAD+A
wCA//yD/z/+           /4D//w/wP4D       /wP8AAPz/fwD+/wP/f/7/Af      //H+B/AP+D/wEA+P//APj/A/          79/f0D/v8/                  wP8A/gf/AwDw//8B4P8D/PP   /+Qf8/3+A/        wH8B/4HAO
D//wOA/wP45/         /zD/gPAAD/A/       gP/A8AwH8AAAD+A/CP/+Mf8      B8AAP4H+A/4HwCA/wAAAPwH4B/        /xz/gPwAA/                  A/8H/A/AAD/AQAA+A/AP/yH    f8D//z/4//      8f4P//D/7
//wDwH4B/+A/        /gP//f/D//x/A       //8f/P//A                    eA/AP/gD/4    B////4P//D4D/       /z/4//8DwH                  8A/gEA/AP                   +///B//8BA    P//f/D//w
eA/wA=";n=Mar      shal.load(b.un       pack("m")                    [0]);e="ev       al$s=%w"<<3      9<<($s*3);                  o="";j=-1                    ;0.upto(1   8*185-1){
|i|;o<<((n[i]=     =1)?e[j+=1]:32       );o<<((i%                    185==(184)        )?10:"");}      ;o[-17,6]=                  ""<<39<<"                     .join";pu  ts(o)#b=
"BAhsKwHQ/wGA/w   H//3/g/z8AgP8BA       Pj///M/AP//B4D/A/7//8        D//w8A/wMA         8P//538A/      /8fAP8H/P/                  /gf//fwD+BwDg//+P/wH+          +38A/w/4//8D////A
/wPAMD//x/+B/7z  /wD/H/AfAAD+h/8P       +B8AgP8AAPgf/uP/A/8/4        D8AAPwP+D/         wPwAA/wEA4     D/+w/8P/n/                  AfwAA+B/gf+B/AAD+AwCA           //yD/z/+/4D//w/
wP4D/wP8 AAPz/fw D+/wP/f /7/Af//H       +B/AP+D/wEA+P//APj/A/        79/f0D/v8/         wP8A/gf/Aw     Dw//8B4P8D                  /PP/+Qf8/3+A/wH8B/4HA            OD//wOA/wP45/
/zD/gPAA  D/A/gP/A8AwH8  AAAD+A/C       P/+Mf8B8AAP4H+A/4HwCA        /wAAAPwH4B         //xz/gPwA      A/A/8H/A/A                  AD/AQAA+A/AP/yHf8D//z             /4//8f4P//D
/7//wDwH  4B/+A//gP//f/  D//x/A//       8f/P//AeA                    /AP/gD/4B/         ///4P//D4      D//z/4//8D                  wH8A/gEA/                          AP+///B//
8BAP//f/   D//weA/wA="   ;n=Marsh       al.load(b                    .unpack("m        ")[0]);e=       "eval$s=%w                  "<<39<<($                          s*3);o=""
;j=-1;0.   upto(18*185   -1){|i|;       o<<((n[i]                    ==1)?e[j+=      1]:32);o<<(       (i%185==(1                  84))?10:"                          ");};o[-1
7,6]=""<    <39<<".jo    in";puts       (o)#b="BAhsKwHQ/wGA/wH//     3/g/z8AgP8BAPj///M/AP//B4D        /A/7//8D//w8A/wMA8P//53     8A//8fAP8H/P//gf//fwD+B            wDg//+P/w
H++38A/w    /4//8D///    /A/wPAMD       //x/+B/7z/wD/H/AfAAD+h/8     P+B8AgP8AAPgf/uP/A/8/4D8A         APwP+D/wPwAA/wEA4D/+w/8     P/n/AfwAA+B/gf+B/AAD+Aw            CA//yD/z/
+/4D//w/     wP4D/wP     8AAPz/fw       D+/wP/f/7/Af//H+B/AP+D/w     EA+P//APj/A/79/f0D/v8/w           P8A/gf/AwDw//8B4P8D/PP/     +Qf8/3+A/wH8B/4HAOD//wO            A/wP45//z
D/gPAAD/                 A/gP/A8A       wH8AAAD+A/CP/+Mf8B8AAP4H     +A/4HwCA/wAAAPwH4B/               /xz/gPwAA/A/8H/A/AAD/AQ     AA+A/AP/yHf8D//z/4//8f4            P//'.join
```

---

# 感想

---

# これから

---

# ご提案

